# Push Notification Capacitor Starter

This repository contains an example implementation of a push notification test app using the Ionic framework with Capacitor. The app demonstrates user registration, login, profile management, and sending push notifications to specific users using a backend API and Firebase Cloud Messaging.

For Cordova and React-Native implementations [click here](./docs/otherImplementations.md)

## Table of Contents

- [Push Notification Capacitor Starter](#push-notification-capacitor-starter)
  - [Table of Contents](#table-of-contents)
  - [Features](#features)
  - [Requirements](#requirements)
  - [Getting Started](#getting-started)
    - [Prerequisites](#prerequisites)
    - [Installation](#installation)
  - [Project Structure](#project-structure)
  - [Configuration](#configuration)
    - [Capacitor Configuration](#capacitor-configuration)
    - [Firebase Configuration](#firebase-configuration)
  - [Running the App](#running-the-app)
    - [Development](#development)
    - [Android Build](#android-build)
    - [iOS Build](#ios-build)
  - [Compiling App](#compiling-app)
  - [Handle Push Notifications](#handle-push-notifications)
  - [API Integration](#api-integration)
  - [Troubleshooting](#troubleshooting)

## Features

- User registration with username, email, password, and device token
- User login with email and password
- User profile page displaying user details and associated device tokens
- Send push notifications to specific users
- Integration with a backend API for user authentication and notification handling

## Requirements

- Node.js (v14.x or later)
- NPM (v6.x or later)
- Ionic CLI (v6.x or later)
- Capacitor CLI (v3.x or later)
- Android SDK (for Android build)
- Xcode (for iOS build)

## Getting Started

### Prerequisites

Before you begin, ensure that you have the following installed on your system:

- Node.js: [Download and Install Node.js](https://nodejs.org)
- Ionic CLI: Install globally using npm

```bash
npm install -g @ionic/cli
```

- Capacitor CLI: Install globally using npm

```bash
npm install -g @capacitor/cli
```

### Installation

1. Clone the repository:

```bash
git clone git@github.com:charlpcronje/Push-Notification-Capacitor-Starter.git
```

2. Navigate to the project directory:

```bash
cd push-test
```

3. Install the dependencies:

```bash
npm install
```

4. Add the Android platform:

```bash
npx cap add android
```

5. Add the iOS platform (macOS only):

```bash
npx cap add ios
```

## Project Structure

The project structure is as follows:

```
push-test/
  |- android/
  |- ios/
  |- node_modules/
  |- public/
  |- src/
  |   |- assets/
  |   |- components/
  |   |- router/
  |   |- services/
  |   |- theme/
  |   |- views/
  |   |- App.vue
  |   |- main.ts
  |- .gitignore
  |- capacitor.config.ts
  |- ionic.config.json
  |- package.json
  |- README.md
  |- tsconfig.json
```

- `android/`: Contains the Android project files generated by Capacitor.
- `ios/`: Contains the iOS project files generated by Capacitor.
- `node_modules/`: Contains the project dependencies installed by npm.
- `public/`: Contains the public assets of the app.
- `src/`: Contains the main source code of the app.
  - `assets/`: Contains static assets used in the app.
  - `components/`: Contains reusable Vue components.
  - `router/`: Contains the Vue Router configuration.
  - `services/`: Contains services for authentication and notification handling.
  - `theme/`: Contains the app's theme styles.
  - `views/`: Contains the main views/pages of the app.
  - `App.vue`: The root component of the app.
  - `main.ts`: The entry point of the app.
- `.gitignore`: Specifies files and directories to be ignored by Git.
- `capacitor.config.ts`: Configuration file for Capacitor.
- `ionic.config.json`: Configuration file for Ionic.
- `package.json`: Contains project metadata and dependencies.
- `README.md`: The project readme file.
- `tsconfig.json`: TypeScript configuration file.

## Configuration

### Capacitor Configuration

The `capacitor.config.ts` file contains the configuration for Capacitor. You can modify the app ID, app name, and other settings in this file.

```typescript
import { CapacitorConfig } from '@capacitor/cli';

const config: CapacitorConfig = {
  appId: 'com.fgx.pulsetest',
  appName: 'Push Test',
  webDir: 'dist',
  server: {
    androidScheme: 'https'
  },
  plugins: {
    PushNotifications: {
      presentationOptions: ["badge", "sound", "alert"]
    }
  }
};

export default config;
```

### Firebase Configuration

To enable push notifications, you need to set up a Firebase project and add the Firebase configuration files to your project.

1. Create a new Firebase project in the [Firebase Console](https://console.firebase.google.com).

2. Generate the `google-services.json` file for your Android app and place it in the `android/app` directory.

3. Generate the `GoogleService-Info.plist` file for your iOS app and place it in the `ios/App` directory.

4. Update the `capacitor.config.ts` file with your Firebase project details:

```typescript
import { CapacitorConfig } from '@capacitor/cli';

const config: CapacitorConfig = {
    // ...
    plugins: {
    // ...
    PushNotifications: {
        presentationOptions: ["badge", "sound", "alert"]
    }
  }
};

export default config;
```

## Running the App

### Development

To run the app in development mode, use the following command:

```bash
ionic serve
```

This will start a development server and open the app in your default browser. The app will automatically reload if you make any changes to the source files.

### Android Build

To build the app for Android, follow these steps:

1. Build the web assets:

```bash
ionic build
```

2. Copy the web assets to the Android project:

```bash
npx cap copy
```

3. Open the Android project in Android Studio:

```bash
npx cap open android
```

4. In Android Studio, build and run the app on an Android device or emulator.

### iOS Build

To build the app for iOS (macOS only), follow these steps:

1. Build the web assets:

```bash
ionic build
```

2. Copy the web assets to the iOS project:

```bash
npx cap copy
```

3. Open the iOS project in Xcode:

```bash
npx cap open ios
```

4. In Xcode, build and run the app on an iOS device or simulator.

## Compiling App
Follow these steps:

1. Open the `android/app/google-services.json` file in your project.
2. Check the `package_name` value in the `google-services.json` file. It should match the package name specified in your project's `android/app/src/main/AndroidManifest.xml` file.
3. Open the `android/app/src/main/AndroidManifest.xml` file and locate the `package` attribute in the `manifest` tag. Update the package name to match the one specified in the `google-services.json` file.

For example, if your `google-services.json` file has the package name `com.example.myapp`, update the `AndroidManifest.xml` file like this:
```xml
<manifest xmlns:android="http://schemas.android.com/apk/res/android"
    package="com.example.myapp">
    ...
</manifest>
```

4. Open the `capacitor.config.ts` file in your project's root directory and update the `appId` property to match the package name specified in the `google-services.json` and `AndroidManifest.xml` files.

```typescript
import { CapacitorConfig } from '@capacitor/cli';

const config: CapacitorConfig = {
    appId: 'com.example.myapp',
    // ...
};

export default config;
```

5. Open the `android/app/build.gradle` file and update the applicationId in the `defaultConfig` block to match the package name.

```gradle
defaultConfig {
    applicationId "com.example.myapp"
    // ...
}
```

6. Save all the modified files.
7. Clean the Android project by running the following command in the `android` directory:
   
```
./gradlew clean
```

8. Rebuild the Android project:

- For a debug build:
```
./gradlew assembleDebug
```

- For a release build (requires signing configuration):
```
./gradlew assembleRelease
```
The build process will start, and Gradle will compile your code, resources, and dependencies into an APK file.

This command should now build the project successfully without the "No matching client found for package name" error.

- Make sure that the package name you use is consistent across the `google-services.json` file, `AndroidManifest.xml` file, and `capacitor.config.ts` file.
- If you still encounter issues after following these steps, please provide the contents of your `google-services.json` file (redact any sensitive information) and the relevant parts of your `AndroidManifest.xml` file so I can take a closer look and provide more specific guidance.

Once the build is successful, you can find the generated APK file in the following location:

9. Once the build is successful, you can find the generated APK file in the following location:

- For a debug build:

```
/var/www/html/pulse.fgx.webally.co.za/push-test/android/app/build/outputs/apk/debug/app-debug.apk
```

- For a release build:

```
/path/to/your/project/android/app/build/outputs/apk/release/app-release.apk
```
Note: The exact location of the APK file may vary depending on your project's configuration.

## Handle Push Notifications

When I mention "handle incoming push notifications," I'm referring to the actions your app takes when it receives a push notification from the Firebase Cloud Messaging (FCM) service. There are different ways you can handle incoming push notifications in your app, depending on your app's requirements and the user experience you want to provide. Here are a few common ways to handle incoming push notifications:

1. Display a notification message:
   - When your app receives a push notification, you can display it as a system notification using the device's notification center.
   - The notification message typically includes a title, body, and optional data payload.
   - Users can tap on the notification to open the app or perform a specific action.

2. Update the app's UI:
   - If your app is in the foreground when a push notification is received, you can update the app's user interface in real-time to reflect the notification's content.
   - For example, if the notification indicates a new message or an event, you can update the relevant screen or badge count in your app to notify the user.

3. Perform background actions:
   - Push notifications can trigger background actions in your app, even when the app is not actively running.
   - For example, if the notification contains data for syncing or updating the app's content, you can handle it in the background without requiring user interaction.

4. Deep linking and navigation:
   - Push notifications can include deep links or custom data that instruct your app to navigate to a specific screen or perform a particular action when the user taps on the notification.
   - You can parse the notification payload and use it to determine the appropriate navigation or action within your app.

5. Silent notifications:
   - FCM supports sending silent notifications, which are notifications that do not display a message to the user but are instead used to trigger background tasks or data updates in your app.
   - Your app can listen for these silent notifications and perform the necessary actions without user intervention.

To handle incoming push notifications in your app, you'll need to use the Capacitor Push Notifications plugin (https://capacitorjs.com/docs/apis/push-notifications) and configure it to listen for notifications. The plugin provides event listeners that you can use to handle different types of notifications, such as `pushNotificationReceived` and `pushNotificationActionPerformed`.

In your `notification.service.ts` file, you can implement the logic to handle these events and perform the appropriate actions based on the notification payload. For example, you can display a local notification, update the app's UI, navigate to a specific screen, or trigger background tasks.

Here's a simplified example of handling an incoming push notification in the `notification.service.ts` file:

```typescript
import { PushNotifications } from '@capacitor/push-notifications';

// ...

// Listen for incoming push notifications
PushNotifications.addListener('pushNotificationReceived', (notification: PushNotificationSchema) => {
  console.log('Push notification received:', notification);
  
  // Display a local notification
  PushNotifications.localNotification({
    title: notification.title,
    body: notification.body,
    // ...
  });
  
  // Update the app's UI or trigger other actions based on the notification payload
  // ...
});
```



```typescript
import { Capacitor } from '@capacitor/core';
import { PushNotifications, PushNotificationSchema, PushNotificationActionPerformed, PushNotificationToken } from '@capacitor/push-notifications';
import { Router } from '@ionic/vue-router';

export class NotificationService {
  private router: Router;

  constructor(router: Router) {
    this.router = router;
    this.initialize();
  }

  private initialize() {
    if (Capacitor.isNativePlatform()) {
      // Request permission to receive push notifications
      PushNotifications.requestPermissions().then(result => {
        if (result.receive === 'granted') {
          // Register with FCM
          PushNotifications.register();
        } else {
          console.log('Push notification permission denied');
        }
      });

      // Get FCM token
      PushNotifications.addListener('registration', (token: PushNotificationToken) => {
        console.log('FCM registration token:', token.value);
        // TODO: Send the token to your backend server
      });

      // Handle incoming push notifications
      PushNotifications.addListener('pushNotificationReceived', (notification: PushNotificationSchema) => {
        console.log('Push notification received:', notification);

        // Display a notification message
        this.displayNotification(notification);

        // Update the app's UI
        this.updateUI(notification);

        // Perform background actions
        this.performBackgroundActions(notification);
      });

      // Handle notification actions
      PushNotifications.addListener('pushNotificationActionPerformed', (notification: PushNotificationActionPerformed) => {
        console.log('Push notification action performed:', notification);

        // Handle deep linking and navigation
        this.handleDeepLinking(notification);
      });
    }
  }

  private displayNotification(notification: PushNotificationSchema) {
    // Display the notification using the Capacitor LocalNotifications plugin
    PushNotifications.localNotification({
      title: notification.title,
      body: notification.body,
      // Add more options as needed (icon, sound, etc.)
    });
  }

  private updateUI(notification: PushNotificationSchema) {
    // Example: Update a badge count in the UI
    const badgeCount = document.querySelector('.badge-count');
    if (badgeCount) {
      const count = parseInt(badgeCount.textContent || '0', 10) + 1;
      badgeCount.textContent = count.toString();
    }
  }

  private performBackgroundActions(notification: PushNotificationSchema) {
    // Example: Sync data in the background
    if (notification.data && notification.data.action === 'sync') {
      // Perform background sync
      console.log('Performing background sync');
      // TODO: Implement your sync logic here
    }
  }

  private handleDeepLinking(notification: PushNotificationActionPerformed) {
    // Example: Navigate to a specific page based on the notification action
    if (notification.actionId === 'view_order') {
      const orderId = notification.notification.data.orderId;
      this.router.navigate(['/orders', orderId]);
    }
  }
}
```

In this example:

1. The `NotificationService` class is responsible for handling push notifications.

2. The `initialize` method is called when the service is instantiated. It requests permission to receive push notifications, registers with FCM, and sets up listeners for incoming notifications and notification actions.

3. The `displayNotification` method is called when a push notification is received. It uses the Capacitor LocalNotifications plugin to display the notification message to the user.

4. The `updateUI` method is called when a push notification is received. It demonstrates updating a badge count in the UI based on the received notification. You can customize this method to update other parts of your app's UI as needed.

5. The `performBackgroundActions` method is called when a push notification is received. It checks the notification payload for a specific action (`'sync'` in this example) and performs corresponding background tasks. You can extend this method to handle different background actions based on your app's requirements.

6. The `handleDeepLinking` method is called when a notification action is performed. It demonstrates navigating to a specific page in your app based on the action ID (`'view_order'` in this example) and any associated data in the notification payload.

Remember to customize the code according to your app's specific requirements, integrate it with your existing services and components, and handle any additional data or actions as needed.

Also, make sure to send the FCM registration token to your backend server (as mentioned in the `TODO` comment) so that your server can send push notifications to the registered devices.

Note: This code assumes you have the necessary Capacitor plugins installed and configured, such as `@capacitor/push-notifications` and `@capacitor/local-notifications`.

Remember to customize the notification handling logic based on your app's specific requirements and user experience goals.

It's also important to handle scenarios where the user interacts with the notification, such as tapping on it to open the app or perform an action. You can use the `pushNotificationActionPerformed` event listener to handle these user actions and respond accordingly.

Handling push notifications effectively involves considering the user experience, performance, and app functionality to provide a seamless and engaging experience for your app's users.



## API Integration

- [API Setup](./docs/apiIntegration.md)

The app integrates with a backend API for user authentication and notification handling. The API endpoints and their purposes are as follows:

- **Registration** (`/api/user/register`):
  - Method: POST
  - Purpose: Register a new user with username, email, password, and device token.

- **Login** (`/api/user/login`):
  - Method: POST
  - Purpose: Authenticate user credentials and retrieve a JWT token.

- **User Details** (`/api/user/user_details`):
  - Method: GET
  - Purpose: Retrieve user profile information, including associated device tokens.

- **Update Device Token** (`/api/user/update_device_token`):
  - Method: POST
  - Purpose: Update the device token for a user.

- **Send Notification** (`/api/notification/send_notification`):
  - Method: POST
  - Purpose: Send a push notification to a specific user's device.

Make sure to update the API base URL in the `src/services/auth.service.ts` and `src/services/notification.service.ts` files to match your backend API URL.

## Troubleshooting

If you encounter any issues while running or building the app, try the following:

- Ensure that you have the latest versions of Node.js, Ionic CLI, and Capacitor CLI installed.
- Run `npm install` to ensure all dependencies are up to date.
- Check the console for any error messages or stacktraces that may help identify the issue.
- Refer to the [Ionic documentation](https://ionicframework.com/docs) and [Capacitor documentation](https://capacitorjs.com/docs) for additional troubleshooting guidance.

If the issue persists, please create an issue in the repository with a detailed description of the problem and steps to reproduce it. Make sure to include logs, stack traces, and any other output that may help identify the cause.